# https://github.com/Mattraks/delete-workflow-runs
name: ðŸ§¹ æ™ºèƒ½æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•

on:
  schedule:
    # æ¯æœˆç¬¬ä¸€å¤© 02:00 UTC è‡ªåŠ¨æ¸…ç† (é¿å¼€å‘ç‰ˆé«˜å³°æœŸ)
    - cron: "0 2 1 * *"
  workflow_dispatch:
    inputs:
      cleanup_strategy:
        description: "æ¸…ç†ç­–ç•¥"
        required: true
        default: "conservative"
        type: choice
        options:
          - "conservative" # ä¿å®ˆæ¨¡å¼ï¼šåªæ¸…ç†å¤±è´¥/å–æ¶ˆçš„è¿è¡Œ
          - "aggressive" # æ¿€è¿›æ¨¡å¼ï¼šæ¸…ç†æ‰€æœ‰æ—§è¿è¡Œ
          - "test_only" # ä»…æ¸…ç†æµ‹è¯•å·¥ä½œæµ
      days:
        description: "ä¿ç•™å¤©æ•° (ä¿å®ˆæ¨¡å¼: 45å¤©, æ¿€è¿›æ¨¡å¼: 30å¤©)"
        required: false
        default: "45"
      minimum_runs:
        description: "æ¯ä¸ªå·¥ä½œæµæœ€å°‘ä¿ç•™è¿è¡Œæ•°"
        required: false
        default: "8"
      target_workflow:
        description: "ç›®æ ‡å·¥ä½œæµåç§° (ç•™ç©ºæ¸…ç†æ‰€æœ‰)"
        required: false
      dry_run:
        description: "æ¨¡æ‹Ÿè¿è¡Œ (ä¸å®žé™…åˆ é™¤)"
        required: false
        type: boolean
        default: false

jobs:
  # ä¿å®ˆæ¸…ç†ï¼šä¼˜å…ˆæ¸…ç†å¤±è´¥å’Œå–æ¶ˆçš„è¿è¡Œï¼Œä¿æŠ¤é‡è¦è®°å½•
  conservative-cleanup:
    if: github.event.inputs.cleanup_strategy == 'conservative' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: ðŸ§¹ æ¸…ç†å¤±è´¥å’Œå–æ¶ˆçš„è¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: ${{ github.event.inputs.days || '45' }}
          keep_minimum_runs: ${{ github.event.inputs.minimum_runs || '8' }}
          delete_workflow_pattern: ${{ github.event.inputs.target_workflow }}
          delete_workflow_by_state_pattern: "active"
          delete_run_by_conclusion_pattern: "cancelled,failure,action_required"
          dry_run: ${{ github.event.inputs.dry_run || 'false' }}
          check_branch_existence: true
          check_pullrequest_exist: true

      - name: ðŸ§¹ æ¸…ç†è·³è¿‡çš„è¿è¡Œè®°å½• (æ›´é•¿ä¿ç•™æœŸ)
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: "60" # è·³è¿‡çš„è®°å½•ä¿ç•™æ›´é•¿æ—¶é—´
          keep_minimum_runs: ${{ github.event.inputs.minimum_runs || '8' }}
          delete_workflow_pattern: ${{ github.event.inputs.target_workflow }}
          delete_workflow_by_state_pattern: "active"
          delete_run_by_conclusion_pattern: "skipped"
          dry_run: ${{ github.event.inputs.dry_run || 'false' }}
          check_branch_existence: true
          check_pullrequest_exist: true

  # æ¿€è¿›æ¸…ç†ï¼šæ¸…ç†æ‰€æœ‰æ—§è¿è¡Œï¼ˆåŒ…æ‹¬æˆåŠŸçš„ï¼‰
  aggressive-cleanup:
    if: github.event.inputs.cleanup_strategy == 'aggressive'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: âš¡ æ¿€è¿›æ¸…ç†æ‰€æœ‰æ—§è¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: ${{ github.event.inputs.days || '30' }}
          keep_minimum_runs: ${{ github.event.inputs.minimum_runs || '8' }}
          delete_workflow_pattern: ${{ github.event.inputs.target_workflow }}
          delete_workflow_by_state_pattern: "active"
          delete_run_by_conclusion_pattern: "ALL"
          dry_run: ${{ github.event.inputs.dry_run || 'false' }}
          check_branch_existence: true
          check_pullrequest_exist: true

  # æµ‹è¯•å·¥ä½œæµä¸“ç”¨æ¸…ç†ï¼šé’ˆå¯¹å®žéªŒæ€§å’Œæµ‹è¯•å·¥ä½œæµ
  test-workflow-cleanup:
    if: github.event.inputs.cleanup_strategy == 'test_only'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    strategy:
      matrix:
        workflow_pattern:
          - "use-vercel-cli-and-turbo-build-1.yaml"
          - "use-vercel-cli-build-try-1.yaml"
          - "use-vercel-cli-build-try-2.yaml"
          - "use-vercel-cli-build-try-3.yaml"
          - "use-vercel-cli-build-try-4.yaml"
          - "æ‰¹é‡éƒ¨ç½²vercelé¡¹ç›®"
    steps:
      - name: ðŸ§ª æ¸…ç†å®žéªŒæ€§å·¥ä½œæµè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: "15" # å®žéªŒæ€§å·¥ä½œæµä¿ç•™æœŸæ›´çŸ­
          keep_minimum_runs: "3"
          delete_workflow_pattern: ${{ matrix.workflow_pattern }}
          delete_workflow_by_state_pattern: "active"
          delete_run_by_conclusion_pattern: "ALL"
          dry_run: ${{ github.event.inputs.dry_run || 'false' }}

  # æŠ¥å‘Šæ¸…ç†ç»“æžœ
  cleanup-summary:
    needs: [conservative-cleanup, aggressive-cleanup, test-workflow-cleanup]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š æ¸…ç†å®ŒæˆæŠ¥å‘Š
        run: |
          echo "## ðŸ§¹ å·¥ä½œæµæ¸…ç†å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- æ¸…ç†ç­–ç•¥: ${{ github.event.inputs.cleanup_strategy || 'conservative' }}" >> $GITHUB_STEP_SUMMARY  
          echo "- ä¿ç•™å¤©æ•°: ${{ github.event.inputs.days || '45' }}" >> $GITHUB_STEP_SUMMARY
          echo "- æœ€å°ä¿ç•™æ•°: ${{ github.event.inputs.minimum_runs || '8' }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ¨¡æ‹Ÿè¿è¡Œ: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰§è¡Œæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
